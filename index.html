<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Онлайн Мафия | Голосовой чат + TON</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://cdn.webrtc-experiment.com/RecordRTC.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: white;
            min-height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        /* TikTok-like container with vertical scrolling */
        .app-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scroll-snap-type: y mandatory;
            scroll-behavior: smooth;
        }
        
        .container {
            max-width: 100%;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 0;
            overflow: hidden;
            position: relative;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .game-screen {
            display: none;
            flex: 1;
            padding: 10px;
            overflow: hidden;
            flex-direction: column;
            position: relative;
            scroll-snap-align: start;
            min-height: 100vh;
        }
        
        .active {
            display: flex;
        }
        
        .game-content {
            display: flex;
            flex: 1;
            flex-direction: column;
            height: 100%;
            gap: 12px;
            overflow: hidden;
        }
        
        .game-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: auto;
            padding-bottom: 10px;
        }
        
        /* Стили для раздвижного чата */
        .chat-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            transition: all 0.3s ease;
            transform: translateY(-100%);
            height: calc(100% - 50px);
            display: flex;
            flex-direction: column;
            background: rgba(30, 30, 40, 0.95);
            border-radius: 0 0 20px 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }
        
        .chat-container.open {
            transform: translateY(0);
        }
        
        /* Кнопка чата в верхнем правом углу */
        .chat-toggle-btn {
            position: fixed;
            top: 70px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: #b21f1f;
            border-radius: 50%;
            z-index: 1001;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .chat-toggle-btn:hover {
            transform: scale(1.1);
            background: #8a1c1c;
        }
        
        .chat-toggle-btn .badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ffcc00;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 0.8rem;
            color: #000;
            font-weight: bold;
        }
        
        .chat-icon {
            font-size: 1.5rem;
            color: white;
        }
        
        /* Кнопка списка комнат */
        .rooms-toggle-btn {
            position: fixed;
            top: 130px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: #4CAF50;
            border-radius: 50%;
            z-index: 1001;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        .rooms-toggle-btn:hover {
            transform: scale(1.1);
            background: #3d8b40;
        }
        
        .rooms-icon {
            font-size: 1.5rem;
            color: white;
        }
        
        header {
            text-align: center;
            padding: 10px 15px;
            background: rgba(0, 0, 0, 0.6);
            border-bottom: 2px solid #b21f1f;
            position: sticky;
            top: 0;
            z-index: 10;
            overflow: hidden;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(178, 31, 31, 0.3) 0%, rgba(0,0,0,0) 70%);
        }
        
        .header-content {
            flex: 1;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #4dabf7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .user-name {
            max-width: 120px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .logout-btn {
            background: rgba(178, 31, 31, 0.7);
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            color: #ffcc00;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.7);
            position: relative;
        }
        
        .subtitle {
            font-size: 0.9rem;
            opacity: 0.8;
            position: relative;
        }
        
        .server-status {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(0, 100, 0, 0.5);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
        }
        
        .server-status::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            box-shadow: 0 0 8px #4CAF50;
        }
        
        .auth-container, .join-container, .lobby-container, .profile-container, .rooms-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
            padding: 15px;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
        }
        
        .input-group {
            display: flex;
            gap: 8px;
            width: 100%;
            flex-direction: column;
        }
        
        input {
            flex: 1;
            padding: 12px 15px;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 2px solid #444;
            transition: all 0.3s;
        }
        
        input:focus {
            outline: none;
            border-color: #ffcc00;
            box-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
        }
        
        button {
            padding: 12px;
            background: linear-gradient(to right, #b21f1f, #8a1c1c);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        button:active {
            transform: translateY(2px);
            background: linear-gradient(to right, #a11919, #791919);
        }
        
        button:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .player-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 8px;
            width: 100%;
            margin-top: 12px;
        }
        
        .player-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 10px;
            text-align: center;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            min-height: 80px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .player-name {
            font-weight: bold;
            font-size: 1rem;
            margin-bottom: 4px;
        }
        
        .player-role {
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            margin: 12px 0;
            background: rgba(0, 0, 0, 0.4);
            padding: 10px;
            border-radius: 10px;
            font-size: 0.9rem;
        }
        
        .phase-display {
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
            padding: 10px;
            margin: 12px 0;
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .night {
            background: linear-gradient(to right, #1a237e, #283593);
        }
        
        .day {
            background: linear-gradient(to right, #c62828, #b71c1c);
        }
        
        .action-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 12px;
        }
        
        .action-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .action-title {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: #ffcc00;
        }
        
        .log-container {
            margin-top: 12px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 12px;
            max-height: 140px;
            overflow-y: auto;
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem;
        }
        
        .log-title {
            font-size: 1rem;
            margin-bottom: 6px;
            color: #ffcc00;
        }
        
        .log-entry {
            padding: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.85rem;
        }
        
        .mafia-log {
            color: #ff6b6b;
        }
        
        .sheriff-log {
            color: #4dabf7;
        }
        
        .game-over {
            text-align: center;
            padding: 15px;
        }
        
        .winner-title {
            font-size: 1.6rem;
            color: #ffcc00;
            margin-bottom: 12px;
            text-shadow: 0 0 10px rgba(255, 204, 0, 0.5);
        }
        
        .role-badge {
            display: inline-block;
            padding: 3px 6px;
            border-radius: 12px;
            font-size: 0.7rem;
            margin-left: 6px;
        }
        
        .mafia-badge {
            background: #b21f1f;
        }
        
        .sheriff-badge {
            background: #ffcc00;
            color: black;
        }
        
        .civilian-badge {
            background: #4CAF50;
        }
        
        .doctor-badge {
            background: #9c27b0;
        }
        
        .lover-badge {
            background: #e91e63;
        }
        
        .maniac-badge {
            background: #ff9800;
            color: black;
        }
        
        .player-status {
            font-size: 0.75rem;
            margin-top: 4px;
        }
        
        .alive {
            color: #4CAF50;
        }
        
        .dead {
            color: #f44336;
            text-decoration: line-through;
        }
        
        .room-info {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 10px;
            font-size: 0.85rem;
        }
        
        .room-id {
            font-family: monospace;
            font-size: 0.9rem;
            letter-spacing: 1px;
        }
        
        .copy-btn {
            padding: 6px 10px;
            background: #444;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .instructions {
            background: rgba(0, 0, 0, 0.4);
            padding: 10px;
            border-radius: 10px;
            margin-top: 12px;
            font-size: 0.8rem;
            line-height: 1.4;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .instructions h3 {
            color: #ffcc00;
            margin-bottom: 6px;
            font-size: 0.95rem;
        }
        
        .instructions ul {
            padding-left: 18px;
        }
        
        .instructions li {
            margin-bottom: 5px;
        }
        
        .back-btn {
            position: absolute;
            top: 12px;
            left: 12px;
            padding: 6px 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
            font-size: 0.85rem;
        }
        
        .firebase-status {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(0, 100, 0, 0.5);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
        }
        
        .firebase-status.offline {
            background: rgba(100, 0, 0, 0.5);
        }
        
        .role-info {
            background: rgba(0, 0, 0, 0.4);
            padding: 8px;
            border-radius: 8px;
            margin-top: 6px;
            font-size: 0.8rem;
            border-left: 3px solid #ffcc00;
        }
        
        /* Стили для чата */
        .chat-header {
            background: #1a1a2e;
            padding: 10px;
            text-align: center;
            font-weight: bold;
            border-bottom: 1px solid #444;
            font-size: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-messages {
            flex: 1;
            padding: 8px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .chat-input-container {
            display: flex;
            padding: 8px;
            background: #1a1a2e;
            border-top: 1px solid #444;
            align-items: center;
        }
        
        .chat-input {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 0.95rem;
            margin: 0 8px;
        }
        
        .chat-send-btn {
            padding: 10px 16px;
            background: #b21f1f;
            border: none;
            border-radius: 18px;
            color: white;
            cursor: pointer;
            min-width: 55px;
        }
        
        .message {
            max-width: 85%;
            padding: 8px 12px;
            border-radius: 14px;
            position: relative;
            word-wrap: break-word;
            font-size: 0.9rem;
        }
        
        .message-sender {
            font-weight: bold;
            margin-bottom: 2px;
            font-size: 0.8rem;
        }
        
        .message-content {
            line-height: 1.3;
        }
        
        .message-time {
            font-size: 0.6rem;
            opacity: 0.6;
            text-align: right;
            margin-top: 2px;
        }
        
        .message-incoming {
            align-self: flex-start;
            background: rgba(50, 50, 70, 0.8);
            border-bottom-left-radius: 5px;
        }
        
        .message-outgoing {
            align-self: flex-end;
            background: rgba(70, 50, 120, 0.8);
            border-bottom-right-radius: 5px;
        }
        
        .system-message {
            align-self: center;
            background: rgba(255, 204, 0, 0.2);
            text-align: center;
            padding: 6px 10px;
            border-radius: 18px;
            font-size: 0.8rem;
            margin: 4px 0;
        }
        
        .close-chat-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.1rem;
            cursor: pointer;
            padding: 4px;
        }
        
        /* Стили для профиля */
        .profile-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            width: 100%;
            text-align: center;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: #4dabf7;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem;
            font-weight: bold;
            margin: 0 auto 15px;
        }
        
        .profile-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            width: 100%;
            margin-top: 20px;
        }
        
        .stat-card {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            padding: 15px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #ffcc00;
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .profile-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }
        
        /* Стили для списка комнат */
        .rooms-list {
            width: 100%;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .room-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s;
        }
        
        .room-item:last-child {
            border-bottom: none;
        }
        
        .room-item:hover {
            background: rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }
        
        .room-details {
            display: flex;
            flex-direction: column;
        }
        
        .room-status {
            font-size: 0.8rem;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .room-status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .status-waiting {
            background-color: #4CAF50;
        }
        
        .status-in-progress {
            background-color: #FFC107;
        }
        
        .status-full {
            background-color: #F44336;
        }
        
        .room-actions {
            display: flex;
            gap: 8px;
        }
        
        .join-room-btn {
            padding: 8px 15px;
            background: #4CAF50;
            border-radius: 20px;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            color: white;
            transition: all 0.3s;
        }
        
        .join-room-btn:hover {
            background: #3d8b40;
            transform: scale(1.05);
        }
        
        /* Стили для popup сообщений */
        .chat-popup-container {
            position: fixed;
            bottom: 70px;
            left: 10px;
            right: 10px;
            z-index: 2000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .chat-popup {
            background: rgba(40, 40, 60, 0.95);
            border-radius: 12px;
            padding: 12px 15px;
            border-left: 4px solid #4dabf7;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            animation: popupAppear 0.4s ease-out;
            backdrop-filter: blur(5px);
        }
        
        @keyframes popupAppear {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .chat-popup-sender {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 3px;
            color: #ffcc00;
        }
        
        .chat-popup-content {
            font-size: 0.95rem;
            line-height: 1.3;
        }
        
        /* Модальное окно для списка комнат */
        .rooms-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .rooms-modal.open {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: rgba(30, 30, 40, 0.95);
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .modal-header {
            background: #1a1a2e;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #444;
        }
        
        .modal-header h3 {
            font-size: 1.2rem;
            color: #ffcc00;
        }
        
        .close-modal-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .modal-body {
            padding: 15px;
            max-height: calc(80vh - 70px);
            overflow-y: auto;
        }
        
        /* Таймер фазы */
        .phase-timer {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.9rem;
        }
        
        /* Стили для голосовых сообщений */
        .voice-message-btn {
            padding: 10px;
            background: #444;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
        }
        
        .voice-message-btn.recording {
            background: #b21f1f;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(178, 31, 31, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(178, 31, 31, 0); }
            100% { box-shadow: 0 0 0 0 rgba(178, 31, 31, 0); }
        }
        
        .audio-message {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 5px;
            width: 100%;
        }
        
        .audio-message audio {
            width: 100%;
            max-width: 250px;
            height: 40px;
            outline: none;
            background: rgba(0,0,0,0.3);
            border-radius: 20px;
        }
        
        .audio-duration {
            font-size: 0.8rem;
            opacity: 0.7;
            margin-top: 3px;
        }
        
        .voice-recorder-indicator {
            position: absolute;
            bottom: 60px;
            left: 0;
            right: 0;
            text-align: center;
            background: rgba(178, 31, 31, 0.8);
            padding: 8px;
            font-weight: bold;
            display: none;
        }
        
        .voice-recorder-indicator.visible {
            display: block;
        }
        
        .audio-duration-indicator {
            font-size: 0.8rem;
            opacity: 0.8;
            margin-left: 8px;
        }
        
        /* VIP стили */
        .vip-badge {
            display: inline-block;
            background: linear-gradient(45deg, #ffd700, #ffa500);
            color: #000;
            font-weight: bold;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-left: 5px;
        }
        
        .ton-balance {
            background: #0088cc;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85rem;
        }
        
        .vip-shop {
            background: rgba(255, 215, 0, 0.1);
            border: 1px solid #ffd700;
            border-radius: 15px;
            padding: 15px;
            margin-top: 15px;
            width: 100%;
        }
        
        .vip-role-card {
            background: rgba(0, 0, 0, 0.4);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 10px;
            border: 1px solid #444;
        }
        
        /* Адаптация для очень маленьких экранов */
        @media (max-width: 360px) {
            h1 {
                font-size: 1.3rem;
            }
            
            .player-list {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
            
            .action-card {
                padding: 10px;
            }
            
            button {
                padding: 10px;
                font-size: 0.95rem;
            }
            
            .user-name {
                max-width: 80px;
            }
            
            .chat-toggle-btn, .rooms-toggle-btn {
                top: 60px;
                right: 15px;
                width: 45px;
                height: 45px;
            }
            
            .rooms-toggle-btn {
                top: 115px;
            }
        }
        
        /* Горизонтальная ориентация */
        @media (min-width: 768px) {
            .container {
                max-width: 750px;
                height: 97vh;
                margin: 10px auto;
            }
            
            .chat-toggle-btn, .rooms-toggle-btn {
                top: 80px;
                right: 30px;
            }
            
            .rooms-toggle-btn {
                top: 140px;
            }
        }
        
        /* Вертикальный скролл как в TikTok */
        .scrollable-section {
            height: calc(100vh - 60px);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none; /* Firefox */
        }
        
        .scrollable-section::-webkit-scrollbar {
            display: none; /* Chrome, Safari, Opera */
        }
        
        /* Улучшение для вертикального скролла */
        .join-container, .lobby-container, .profile-container, .auth-container, .rooms-container {
            height: auto;
            min-height: calc(100vh - 150px);
        }
        
        /* Плавный скролл */
        html {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="container">
            <div class="firebase-status" id="firebaseStatus">
                <i class="fas fa-database"></i> Firebase Online
            </div>
            
            <!-- Кнопка чата в верхнем правом углу -->
            <div class="chat-toggle-btn" id="chatToggleBtn">
                <i class="fas fa-comment-dots chat-icon"></i>
                <div class="badge" id="unreadBadge" style="display: none;">0</div>
            </div>
            
            <!-- Кнопка списка комнат -->
            <div class="rooms-toggle-btn" id="roomsToggleBtn">
                <i class="fas fa-door-open rooms-icon"></i>
            </div>
            
            <header>
                <div class="header-content">
                    <h1><i class="fas fa-user-secret"></i> МАФИЯ ДЛЯ СМАРТФОНА</h1>
                    <div class="subtitle">Играйте с друзьями и общайтесь в голосовом чате</div>
                </div>
                <div class="user-info" id="userInfo" style="display: none;">
                    <div class="user-avatar" id="userAvatar">?</div>
                    <div class="user-name" id="userName">Гость</div>
                    <div class="ton-balance" id="tonBalance">0 TON</div>
                    <button class="logout-btn" id="logoutBtn" title="Выйти">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </header>
            
            <!-- Экран аутентификации -->
            <div id="authScreen" class="game-screen active">
                <div class="auth-container scrollable-section">
                    <h2>Вход / Регистрация</h2>
                    <div class="input-group">
                        <input type="text" id="emailInput" placeholder="Email" value="test@example.com">
                        <input type="password" id="passwordInput" placeholder="Пароль" value="password">
                        <div style="display: flex; gap: 10px;">
                            <button id="loginBtn" style="flex: 1;">Войти</button>
                            <button id="signupBtn" style="flex: 1;">Зарегистрироваться</button>
                        </div>
                        <button id="guestBtn">Играть как гость</button>
                    </div>
                </div>
            </div>
            
            <!-- Экран профиля -->
            <div id="profileScreen" class="game-screen">
                <div class="back-btn" id="backToMainBtn">
                    <i class="fas fa-arrow-left"></i> Назад
                </div>
                
                <div class="profile-container scrollable-section">
                    <div class="profile-card">
                        <div class="profile-avatar" id="profileAvatar">?</div>
                        <h2 id="profileName">Игрок</h2>
                        <div id="profileEmail" class="subtitle">email@example.com</div>
                        
                        <div class="profile-stats">
                            <div class="stat-card">
                                <div class="stat-value" id="gamesPlayed">0</div>
                                <div class="stat-label">Игр сыграно</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="gamesWon">0</div>
                                <div class="stat-label">Побед</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="mafiaWins">0</div>
                                <div class="stat-label">Побед мафией</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="civilianWins">0</div>
                                <div class="stat-label">Побед мирным</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="vip-shop" id="vipShop" style="display: none;">
                        <h3><i class="fas fa-crown"></i> VIP Магазин</h3>
                        <div id="vipRoleList"></div>
                        <button id="getTestTonBtn" style="margin-top: 10px;">Получить тестовые TON (100)</button>
                    </div>
                    
                    <div class="profile-actions">
                        <button id="playBtn">Играть</button>
                        <button id="historyBtn">История игр</button>
                    </div>
                </div>
            </div>
            
            <!-- Экран входа в игру -->
            <div id="joinScreen" class="game-screen">
                <div class="back-btn" id="backToProfileBtn">
                    <i class="fas fa-arrow-left"></i> Назад
                </div>
                
                <div class="join-container scrollable-section">
                    <div class="input-group">
                        <input type="text" id="roomIdInput" placeholder="Введите ID комнаты (MAF-1234)">
                        <button id="joinRoomBtn">Присоединиться</button>
                    </div>
                    
                    <div class="input-group">
                        <button id="createRoomBtn">Создать новую игру</button>
                    </div>
                    
                    <div class="instructions">
                        <h3><i class="fas fa-info-circle"></i> Как играть:</h3>
                        <ul>
                            <li>Создайте игру или присоединитесь по ID</li>
                            <li>Игра распределяет роли: Мафия, Шериф, Мирные</li>
                            <li>Ночью мафия убивает, шериф проверяет</li>
                            <li>Днём обсуждайте и голосуйте за подозреваемого</li>
                            <li>Общайтесь с игроками в голосовом чате</li>
                            <li><b>VIP:</b> Покупайте особые роли за TON</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Лобби -->
            <div id="lobbyScreen" class="game-screen">
                <div class="back-btn" id="backBtn">
                    <i class="fas fa-arrow-left"></i> Назад
                </div>
                
                <div class="game-content">
                    <div class="game-main scrollable-section">
                        <div class="lobby-container">
                            <div class="room-info">
                                <div>ID комнаты: <span id="roomId" class="room-id">MAF-0000</span></div>
                                <div class="copy-btn" id="copyBtn"><i class="fas fa-copy"></i></div>
                            </div>
                            
                            <div class="game-info">
                                <div>Игроков: <span id="playerCount">0</span>/5</div>
                                <div>Статус: <span id="lobbyStatus">Ожидание</span></div>
                            </div>
                            
                            <div class="player-list" id="playerList">
                                <!-- Игроки будут добавляться здесь -->
                            </div>
                            
                            <button id="startBtn" disabled>Начать игру</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Игровой экран -->
            <div id="gameScreen" class="game-screen">
                <div class="back-btn" id="backToLobbyBtn">
                    <i class="fas fa-arrow-left"></i>
                </div>
                
                <div class="game-content">
                    <div class="game-main scrollable-section">
                        <div class="phase-timer" id="phaseTimer">02:00</div>
                        
                        <div class="game-info">
                            <div>Игроков: <span id="gamePlayerCount">0</span>/5</div>
                            <div>День: <span id="dayCount">1</span></div>
                        </div>
                        
                        <div id="phaseDisplay" class="phase-display night">НОЧЬ</div>
                        
                        <div class="action-container">
                            <div class="action-card">
                                <div class="action-title">Ваша роль</div>
                                <div id="playerRole">Ожидание...</div>
                                <div class="role-info" id="roleInfo">Описание роли появится здесь</div>
                                <div id="playerStatus" class="player-status alive">Статус: жив</div>
                            </div>
                            
                            <div class="action-card">
                                <div class="action-title">Ваше действие</div>
                                <div id="actionDescription">Ожидайте начала игры...</div>
                                <div id="actionButtons" style="margin-top: 8px;"></div>
                            </div>
                        </div>
                        
                        <div class="log-container">
                            <div class="log-title"><i class="fas fa-scroll"></i> События</div>
                            <div id="gameLog">
                                <div class="log-entry">Игра началась. Наступает ночь...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Экран результатов -->
            <div id="resultScreen" class="game-screen">
                <div class="game-over scrollable-section">
                    <div id="winnerTitle" class="winner-title">Победа мирных жителей!</div>
                    <div class="player-list" id="resultPlayerList">
                        <!-- Результаты игроков будут здесь -->
                    </div>
                    <button id="restartBtn"><i class="fas fa-redo"></i> Новая игра</button>
                </div>
            </div>
            
            <!-- Раздвижной чат -->
            <div class="chat-container" id="chatContainer">
                <div class="chat-header">
                    <span><i class="fas fa-comments"></i> Игровой чат</span>
                    <button class="close-chat-btn" id="closeChatBtn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="system-message">Добро пожаловать в чат! Начните общение с другими игроками.</div>
                </div>
                <div class="chat-input-container">
                    <input type="text" class="chat-input" id="chatInput" placeholder="Напишите сообщение...">
                    <button class="voice-message-btn" id="voiceMessageBtn" title="Записать голосовое сообщение">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <button class="chat-send-btn" id="chatSendBtn"><i class="fas fa-paper-plane"></i></button>
                </div>
                <div class="voice-recorder-indicator" id="voiceRecorderIndicator">
                    <i class="fas fa-microphone"></i> Идет запись... Говорите!
                    <span class="audio-duration-indicator" id="audioDuration">00:00</span>
                </div>
            </div>
            
            <!-- Модальное окно списка комнат -->
            <div class="rooms-modal" id="roomsModal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3><i class="fas fa-door-open"></i> Доступные комнаты</h3>
                        <button class="close-modal-btn" id="closeRoomsModalBtn">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div class="rooms-list" id="roomsList">
                            <div class="room-item">
                                <div class="room-details">
                                    <div class="room-id">Загрузка комнат...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Контейнер для popup сообщений -->
            <div class="chat-popup-container" id="chatPopupContainer"></div>
        </div>
    </div>

    <script>
        // Конфигурация Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDrOAhG2hQphTC8xmI_L1HD835Z101GPAI",
            authDomain: "grean-mafia.firebaseapp.com",
            databaseURL: "https://grean-mafia-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "grean-mafia",
            storageBucket: "grean-mafia.firebasestorage.app",
            messagingSenderId: "603308315781",
            appId: "1:603308315781:web:053d9551ed6516477905ec"
        };
        
        // Инициализация Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // Состояние игры
        let gameState = {
            roomId: '',
            players: [],
            currentPlayer: null,
            dayCount: 1,
            phase: 'night',
            gameOver: false,
            winner: null,
            logs: [],
            votes: {},
            killTarget: null,
            checkTarget: null,
            healTarget: null,
            protectTarget: null,
            murderTarget: null,
            chatMessages: [],
            status: 'waiting',
            phaseEndTime: 0,
            phaseDuration: 120000
        };
        
        // Текущий игрок
        let currentPlayer = {
            id: null,
            name: '',
            role: null,
            status: 'alive',
            isHost: false,
            isVIP: false,
            lastSeen: Date.now()
        };
        
        // Статистика пользователя
        let userStats = {
            gamesPlayed: 0,
            gamesWon: 0,
            mafiaWins: 0,
            civilianWins: 0,
            doctorWins: 0,
            loverWins: 0,
            maniacWins: 0
        };
        
        // Состояние TON
        let userState = {
            tonBalance: 0,
            isVIP: false,
            vipRole: null
        };
        
        // Роли
        const roles = ['mafia', 'sheriff', 'civilian', 'civilian', 'civilian'];
        
        // VIP-роли
        const VIP_ROLES = {
            doctor: {
                name: "Доктор",
                description: "Может лечить одного игрока за ночь, предотвращая убийство",
                cost: 10
            },
            lover: {
                name: "Любовница",
                description: "Может защитить одного игрока ночью, но если она умрет, ее избранник тоже умрет",
                cost: 15
            },
            maniac: {
                name: "Маньяк",
                description: "Независимый убийца, побеждает, если останется последним выжившим",
                cost: 20
            }
        };
        
        // Описания ролей
        const roleDescriptions = {
            mafia: "Вы - мафия! Ночью устраняйте игроков. Днём не попадитесь. Цель - остаться в большинстве.",
            sheriff: "Вы - шериф! Ночью проверяйте игроков. Днём помогайте мирным найти мафию.",
            civilian: "Вы - мирный житель! Ночью спите. Днём обсуждайте и голосуйте, чтобы найти мафию.",
            doctor: "Вы - Доктор! Ночью можете лечить одного игрока, предотвращая его убийство. Цель - помочь мирным.",
            lover: "Вы - Любовница! Ночью можете защитить одного игрока от убийства. Но если вас убьют, ваш избранник умрет с вами.",
            maniac: "Вы - Маньяк! Независимый убийца. Побеждаете, если останетесь последним выжившим."
        };
        
        // Перевод ролей
        const roleTranslations = {
            'mafia': 'Мафия',
            'sheriff': 'Шериф',
            'civilian': 'Мирный',
            'doctor': 'Доктор',
            'lover': 'Любовница',
            'maniac': 'Маньяк'
        };
        
        // DOM элементы
        const authScreen = document.getElementById('authScreen');
        const profileScreen = document.getElementById('profileScreen');
        const joinScreen = document.getElementById('joinScreen');
        const lobbyScreen = document.getElementById('lobbyScreen');
        const gameScreen = document.getElementById('gameScreen');
        const resultScreen = document.getElementById('resultScreen');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const loginBtn = document.getElementById('loginBtn');
        const signupBtn = document.getElementById('signupBtn');
        const guestBtn = document.getElementById('guestBtn');
        const userInfo = document.getElementById('userInfo');
        const userAvatar = document.getElementById('userAvatar');
        const userName = document.getElementById('userName');
        const tonBalance = document.getElementById('tonBalance');
        const logoutBtn = document.getElementById('logoutBtn');
        const profileAvatar = document.getElementById('profileAvatar');
        const profileName = document.getElementById('profileName');
        const profileEmail = document.getElementById('profileEmail');
        const gamesPlayed = document.getElementById('gamesPlayed');
        const gamesWon = document.getElementById('gamesWon');
        const mafiaWins = document.getElementById('mafiaWins');
        const civilianWins = document.getElementById('civilianWins');
        const playBtn = document.getElementById('playBtn');
        const roomIdInput = document.getElementById('roomIdInput');
        const joinRoomBtn = document.getElementById('joinRoomBtn');
        const createRoomBtn = document.getElementById('createRoomBtn');
        const startBtn = document.getElementById('startBtn');
        const playerList = document.getElementById('playerList');
        const playerCount = document.getElementById('playerCount');
        const gamePlayerCount = document.getElementById('gamePlayerCount');
        const dayCount = document.getElementById('dayCount');
        const phaseDisplay = document.getElementById('phaseDisplay');
        const playerRole = document.getElementById('playerRole');
        const roleInfo = document.getElementById('roleInfo');
        const playerStatus = document.getElementById('playerStatus');
        const actionDescription = document.getElementById('actionDescription');
        const actionButtons = document.getElementById('actionButtons');
        const gameLog = document.getElementById('gameLog');
        const resultPlayerList = document.getElementById('resultPlayerList');
        const winnerTitle = document.getElementById('winnerTitle');
        const restartBtn = document.getElementById('restartBtn');
        const roomIdElement = document.getElementById('roomId');
        const copyBtn = document.getElementById('copyBtn');
        const backBtn = document.getElementById('backBtn');
        const backToLobbyBtn = document.getElementById('backToLobbyBtn');
        const backToMainBtn = document.getElementById('backToMainBtn');
        const backToProfileBtn = document.getElementById('backToProfileBtn');
        const lobbyStatus = document.getElementById('lobbyStatus');
        const firebaseStatus = document.getElementById('firebaseStatus');
        const roomsList = document.getElementById('roomsList');
        const phaseTimer = document.getElementById('phaseTimer');
        const vipShop = document.getElementById('vipShop');
        const vipRoleList = document.getElementById('vipRoleList');
        const getTestTonBtn = document.getElementById('getTestTonBtn');
        
        // Элементы чата
        const chatContainer = document.getElementById('chatContainer');
        const chatMessages = document.getElementById('chatMessages');
        const chatInput = document.getElementById('chatInput');
        const chatSendBtn = document.getElementById('chatSendBtn');
        const chatToggleBtn = document.getElementById('chatToggleBtn');
        const closeChatBtn = document.getElementById('closeChatBtn');
        const unreadBadge = document.getElementById('unreadBadge');
        const chatPopupContainer = document.getElementById('chatPopupContainer');
        const voiceMessageBtn = document.getElementById('voiceMessageBtn');
        const voiceRecorderIndicator = document.getElementById('voiceRecorderIndicator');
        const audioDuration = document.getElementById('audioDuration');
        
        // Элементы списка комнат
        const roomsToggleBtn = document.getElementById('roomsToggleBtn');
        const roomsModal = document.getElementById('roomsModal');
        const closeRoomsModalBtn = document.getElementById('closeRoomsModalBtn');
        
        // Состояние чата
        let unreadMessages = 0;
        let lastSeenMessageTime = 0;
        let currentUser = null;
        let timerInterval = null;
        
        // Переменные для записи голоса
        let recorder = null;
        let recordingTimer = null;
        let recordingStartTime = 0;
        let recordedAudio = null;
        
        // Инициализация игры
        function initGame() {
            // Обработчики событий аутентификации
            loginBtn.addEventListener('click', loginUser);
            signupBtn.addEventListener('click', signupUser);
            guestBtn.addEventListener('click', playAsGuest);
            logoutBtn.addEventListener('click', logoutUser);
            playBtn.addEventListener('click', goToJoinScreen);
            backToMainBtn.addEventListener('click', goToAuthScreen);
            backToProfileBtn.addEventListener('click', goToProfileScreen);
            
            // Обработчики игровых событий
            joinRoomBtn.addEventListener('click', joinRoom);
            createRoomBtn.addEventListener('click', createRoom);
            startBtn.addEventListener('click', startGame);
            restartBtn.addEventListener('click', restartGame);
            copyBtn.addEventListener('click', copyRoomId);
            backBtn.addEventListener('click', goBackToJoinScreen);
            backToLobbyBtn.addEventListener('click', goBackToLobby);
            
            // Обработчики чата
            chatSendBtn.addEventListener('click', sendChatMessage);
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendChatMessage();
            });
            
            chatToggleBtn.addEventListener('click', toggleChat);
            closeChatBtn.addEventListener('click', closeChat);
            
            // Обработчики списка комнат
            roomsToggleBtn.addEventListener('click', openRoomsModal);
            closeRoomsModalBtn.addEventListener('click', closeRoomsModal);
            
            // Клик вне модального окна для закрытия
            roomsModal.addEventListener('click', (e) => {
                if (e.target === roomsModal) closeRoomsModal();
            });
            
            // Обработчики голосовых сообщений
            voiceMessageBtn.addEventListener('mousedown', startRecording);
            voiceMessageBtn.addEventListener('mouseup', stopRecording);
            voiceMessageBtn.addEventListener('touchstart', startRecording, {passive: true});
            voiceMessageBtn.addEventListener('touchend', stopRecording);
            
            // Обработчики TON
            getTestTonBtn.addEventListener('click', getTestTon);
            
            // Авто-заполнение для демонстрации
            roomIdInput.value = '';
            
            // Проверка статуса Firebase
            checkFirebaseConnection();
            
            // Проверка состояния аутентификации
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    showProfileScreen();
                    loadUserStats();
                    loadUserState();
                } else {
                    authScreen.classList.add('active');
                    profileScreen.classList.remove('active');
                    userInfo.style.display = 'none';
                }
            });
        }
        
        // Начать запись голоса
        function startRecording(e) {
            e.preventDefault();
            
            // Проверяем поддержку записи голоса
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                alert('Ваш браузер не поддерживает запись голоса');
                return;
            }
            
            // Запрашиваем доступ к микрофону
            navigator.mediaDevices.getUserMedia({ audio: true })
                .then(stream => {
                    // Создаем рекордер
                    recorder = RecordRTC(stream, {
                        type: 'audio',
                        mimeType: 'audio/webm',
                        recorderType: RecordRTC.StereoAudioRecorder,
                        numberOfAudioChannels: 1,
                        desiredSampRate: 16000,
                        timeSlice: 1000,
                        ondataavailable: function(blob) {
                            // Сохраняем записанный кусок
                            recordedAudio = blob;
                        }
                    });
                    
                    // Начинаем запись
                    recorder.startRecording();
                    voiceMessageBtn.classList.add('recording');
                    voiceRecorderIndicator.classList.add('visible');
                    
                    // Запускаем таймер длительности записи
                    recordingStartTime = Date.now();
                    updateRecordingTimer();
                })
                .catch(error => {
                    console.error('Ошибка доступа к микрофону:', error);
                    alert('Не удалось получить доступ к микрофону. Пожалуйста, проверьте разрешения.');
                });
        }
        
        // Обновление таймера записи
        function updateRecordingTimer() {
            if (!recorder) return;
            
            const elapsed = Date.now() - recordingStartTime;
            const seconds = Math.floor(elapsed / 1000);
            const minutes = Math.floor(seconds / 60);
            const displaySeconds = seconds % 60;
            
            audioDuration.textContent = `${minutes.toString().padStart(2, '0')}:${displaySeconds.toString().padStart(2, '0')}`;
            
            // Ограничиваем запись 30 секундами
            if (seconds >= 30) {
                stopRecording();
                return;
            }
            
            recordingTimer = setTimeout(updateRecordingTimer, 1000);
        }
        
        // Остановить запись
        function stopRecording() {
            if (!recorder) return;
            
            // Останавливаем запись
            recorder.stopRecording(() => {
                // Получаем записанный аудио-блоб
                recordedAudio = recorder.getBlob();
                
                // Отправляем голосовое сообщение
                sendVoiceMessage(recordedAudio);
                
                // Освобождаем ресурсы
                recorder = null;
                voiceMessageBtn.classList.remove('recording');
                voiceRecorderIndicator.classList.remove('visible');
                
                // Останавливаем таймер
                if (recordingTimer) {
                    clearTimeout(recordingTimer);
                    recordingTimer = null;
                }
            });
        }
        
        // Отправить голосовое сообщение
        function sendVoiceMessage(audioBlob) {
            if (!currentPlayer.id || !gameState.roomId) return;
            
            // Создаем уникальный ID для сообщения
            const messageId = 'voice_' + Date.now();
            
            // Конвертируем blob в base64 для хранения
            const reader = new FileReader();
            reader.readAsDataURL(audioBlob);
            reader.onloadend = () => {
                const base64Audio = reader.result;
                
                // Создаем сообщение
                const senderName = currentPlayer.name;
                const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
                
                const newMessage = {
                    id: messageId,
                    senderId: currentPlayer.id,
                    senderName: senderName,
                    audioData: base64Audio,
                    timestamp: Date.now(),
                    isAudio: true,
                    duration: duration
                };
                
                // Добавляем сообщение в состояние игры
                gameState.chatMessages.push(newMessage);
                saveGameState();
            };
        }
        
        // Открыть модальное окно списка комнат
        function openRoomsModal() {
            roomsModal.classList.add('open');
            loadRoomsList();
        }
        
        // Закрыть модальное окно списка комнат
        function closeRoomsModal() {
            roomsModal.classList.remove('open');
        }
        
        // Загрузка списка комнат
        function loadRoomsList() {
            roomsList.innerHTML = '<div class="room-item">Загрузка комнат...</div>';
            
            const roomsRef = database.ref('rooms');
            roomsRef.once('value').then(snapshot => {
                const rooms = snapshot.val();
                let roomsHtml = '';
                
                if (rooms) {
                    Object.keys(rooms).forEach(roomId => {
                        const room = rooms[roomId];
                        
                        // Показываем только комнаты в ожидании с местами
                        if (room.status === 'waiting' && room.players && room.players.length < 5) {
                            roomsHtml += `
                                <div class="room-item">
                                    <div class="room-details">
                                        <div class="room-id">${roomId}</div>
                                        <div class="room-status">
                                            <span class="room-status-indicator status-waiting"></span>
                                            Игроков: ${room.players.length}/5
                                        </div>
                                    </div>
                                    <div class="room-actions">
                                        <button class="join-room-btn" data-roomid="${roomId}">Присоединиться</button>
                                    </div>
                                </div>
                            `;
                        }
                    });
                }
                
                if (!roomsHtml) {
                    roomsHtml = '<div class="room-item">Нет доступных комнат. Создайте свою!</div>';
                }
                
                roomsList.innerHTML = roomsHtml;
                
                // Добавляем обработчики для кнопок присоединения
                document.querySelectorAll('.join-room-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const roomId = e.target.getAttribute('data-roomid');
                        roomIdInput.value = roomId;
                        closeRoomsModal();
                        
                        // Авто-фокус на кнопке присоединения
                        setTimeout(() => {
                            joinRoomBtn.focus();
                        }, 300);
                    });
                });
            }).catch(error => {
                roomsList.innerHTML = '<div class="room-item">Ошибка загрузки комнат</div>';
                console.error('Ошибка загрузки комнат:', error);
            });
        }
        
        // Вход пользователя
        function loginUser() {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!email || !password) {
                alert('Введите email и пароль');
                return;
            }
            
            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    currentUser = userCredential.user;
                    showProfileScreen();
                    loadUserStats();
                    loadUserState();
                })
                .catch(error => {
                    alert('Ошибка входа: ' + error.message);
                });
        }
        
        // Регистрация пользователя
        function signupUser() {
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (!email || !password) {
                alert('Введите email и пароль');
                return;
            }
            
            if (password.length < 6) {
                alert('Пароль должен содержать не менее 6 символов');
                return;
            }
            
            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    currentUser = userCredential.user;
                    saveUserStats(); // Создаем запись статистики
                    saveUserState(); // Создаем запись состояния
                    showProfileScreen();
                })
                .catch(error => {
                    alert('Ошибка регистрации: ' + error.message);
                });
        }
        
        // Играть как гость
        function playAsGuest() {
            currentUser = null;
            goToJoinScreen();
        }
        
        // Выход пользователя
        function logoutUser() {
            auth.signOut()
                .then(() => {
                    currentUser = null;
                    authScreen.classList.add('active');
                    profileScreen.classList.remove('active');
                    userInfo.style.display = 'none';
                })
                .catch(error => {
                    alert('Ошибка выхода: ' + error.message);
                });
        }
        
        // Показать экран профиля
        function showProfileScreen() {
            authScreen.classList.remove('active');
            profileScreen.classList.add('active');
            joinScreen.classList.remove('active');
            
            // Обновляем информацию профиля
            const name = getPlayerName();
            const firstLetter = name.charAt(0).toUpperCase();
            
            profileAvatar.textContent = firstLetter;
            profileName.textContent = name;
            profileEmail.textContent = currentUser ? currentUser.email : "Гостевой аккаунт";
            
            userAvatar.textContent = firstLetter;
            userName.textContent = name;
            userInfo.style.display = 'flex';
            
            // Показываем магазин VIP
            vipShop.style.display = 'block';
            showVipShop();
            
            // Обновляем баланс TON
            tonBalance.textContent = userState.tonBalance + ' TON';
        }
        
        // Показать магазин VIP
        function showVipShop() {
            vipRoleList.innerHTML = '';
            
            Object.entries(VIP_ROLES).forEach(([roleId, role]) => {
                const roleDiv = document.createElement('div');
                roleDiv.className = 'vip-role-card';
                
                roleDiv.innerHTML = `
                    <h4>${role.name} - ${role.cost} TON</h4>
                    <p>${role.description}</p>
                    <button class="buy-vip-btn" data-role="${roleId}" 
                        ${userState.tonBalance < role.cost ? 'disabled' : ''}>
                        Купить
                    </button>
                `;
                
                vipRoleList.appendChild(roleDiv);
            });
            
            // Обработчики покупки
            document.querySelectorAll('.buy-vip-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const roleId = btn.getAttribute('data-role');
                    buyVipRole(roleId);
                });
            });
        }
        
        // Купить VIP-роль
        function buyVipRole(roleId) {
            const role = VIP_ROLES[roleId];
            if (!role) return;
            
            if (userState.tonBalance < role.cost) {
                alert('Недостаточно TON для покупки этой роли');
                return;
            }
            
            userState.tonBalance -= role.cost;
            userState.isVIP = true;
            userState.vipRole = roleId;
            
            saveUserState();
            showVipShop();
            tonBalance.textContent = userState.tonBalance + ' TON';
            
            alert(`Вы успешно приобрели роль "${role.name}"!`);
        }
        
        // Получить тестовые TON
        function getTestTon() {
            userState.tonBalance += 100;
            saveUserState();
            showVipShop();
            tonBalance.textContent = userState.tonBalance + ' TON';
            alert('Получено 100 тестовых TON');
        }
        
        // Сохранить состояние пользователя
        function saveUserState() {
            if (!currentUser) return;
            
            const userRef = database.ref(`users/${currentUser.uid}/state`);
            userRef.set(userState);
        }
        
        // Загрузить состояние пользователя
        function loadUserState() {
            if (!currentUser) return;
            
            const userRef = database.ref(`users/${currentUser.uid}/state`);
            userRef.once('value').then(snapshot => {
                if (snapshot.exists()) {
                    userState = snapshot.val();
                }
            });
        }
        
        // Получение имени игрока
        function getPlayerName() {
            if (currentUser) {
                return currentUser.email.split('@')[0];
            }
            return "Гость" + Math.floor(Math.random() * 1000);
        }
        
        // Перейти к экрану входа в игру
        function goToJoinScreen() {
            profileScreen.classList.remove('active');
            joinScreen.classList.add('active');
        }
        
        // Перейти к экрану аутентификации
        function goToAuthScreen() {
            profileScreen.classList.remove('active');
            authScreen.classList.add('active');
        }
        
        // Перейти к экрану профиля
        function goToProfileScreen() {
            joinScreen.classList.remove('active');
            profileScreen.classList.add('active');
        }
        
        // Сохранить статистику пользователя
        function saveUserStats() {
            if (!currentUser) return;
            
            const userRef = database.ref(`users/${currentUser.uid}/stats`);
            userRef.set(userStats);
        }
        
        // Загрузить статистику пользователя
        function loadUserStats() {
            if (!currentUser) return;
            
            const userRef = database.ref(`users/${currentUser.uid}/stats`);
            userRef.once('value').then(snapshot => {
                if (snapshot.exists()) {
                    userStats = snapshot.val();
                    updateProfileStats();
                } else {
                    // Создаем новую запись статистики
                    saveUserStats();
                }
            });
        }
        
        // Обновить статистику в профиле
        function updateProfileStats() {
            gamesPlayed.textContent = userStats.gamesPlayed;
            gamesWon.textContent = userStats.gamesWon;
            mafiaWins.textContent = userStats.mafiaWins;
            civilianWins.textContent = userStats.civilianWins;
        }
        
        // Обновить статистику после игры
        function updateStatsAfterGame(role, won) {
            if (!currentUser) return;
            
            userStats.gamesPlayed++;
            
            if (won) {
                userStats.gamesWon++;
                
                if (role === 'mafia') {
                    userStats.mafiaWins++;
                } else if (role === 'doctor') {
                    userStats.doctorWins++;
                } else if (role === 'lover') {
                    userStats.loverWins++;
                } else if (role === 'maniac') {
                    userStats.maniacWins++;
                } else {
                    userStats.civilianWins++;
                }
            }
            
            saveUserStats();
            updateProfileStats();
        }
        
        // Проверка соединения с Firebase
        function checkFirebaseConnection() {
            const connectedRef = database.ref(".info/connected");
            connectedRef.on("value", (snap) => {
                if (snap.val() === true) {
                    firebaseStatus.innerHTML = '<i class="fas fa-database"></i> Firebase Online';
                    firebaseStatus.classList.remove('offline');
                } else {
                    firebaseStatus.innerHTML = '<i class="fas fa-database"></i> Firebase Offline';
                    firebaseStatus.classList.add('offline');
                }
            });
        }
        
        // Отправка сообщения в чат
        function sendChatMessage() {
            const message = chatInput.value.trim();
            if (message && currentPlayer.id) {
                const senderName = currentPlayer.name;
                
                const newMessage = {
                    senderId: currentPlayer.id,
                    senderName: senderName,
                    text: message,
                    timestamp: Date.now(),
                    isSystem: false
                };
                
                // Добавляем сообщение в состояние игры
                gameState.chatMessages.push(newMessage);
                saveGameState();
                
                // Очищаем поле ввода
                chatInput.value = '';
                
                // Прокручиваем чат вниз
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
        
        // Отображение сообщений чата
        function renderChatMessages() {
            chatMessages.innerHTML = '';
            
            gameState.chatMessages.forEach(msg => {
                const messageDiv = document.createElement('div');
                
                if (msg.isSystem) {
                    // Системное сообщение
                    messageDiv.className = 'system-message';
                    messageDiv.textContent = msg.text;
                } else if (msg.isAudio) {
                    // Аудио-сообщение
                    const isCurrentUser = msg.senderId === currentPlayer.id;
                    messageDiv.className = `message ${isCurrentUser ? 'message-outgoing' : 'message-incoming'}`;
                    
                    const time = new Date(msg.timestamp);
                    const timeString = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
                    
                    // Форматируем длительность
                    const minutes = Math.floor(msg.duration / 60);
                    const seconds = msg.duration % 60;
                    const durationString = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                    messageDiv.innerHTML = `
                        <div class="message-sender">${msg.senderName}</div>
                        <div class="audio-message">
                            <audio controls src="${msg.audioData}"></audio>
                            <span class="audio-duration">${durationString}</span>
                        </div>
                        <div class="message-time">${timeString}</div>
                    `;
                } else {
                    // Текстовое сообщение
                    const isCurrentUser = msg.senderId === currentPlayer.id;
                    messageDiv.className = `message ${isCurrentUser ? 'message-outgoing' : 'message-incoming'}`;
                    
                    const time = new Date(msg.timestamp);
                    const timeString = `${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
                    
                    messageDiv.innerHTML = `
                        <div class="message-sender">${msg.senderName}</div>
                        <div class="message-content">${msg.text}</div>
                        <div class="message-time">${timeString}</div>
                    `;
                    
                    // Считаем непрочитанные сообщения
                    if (!isCurrentUser && msg.timestamp > lastSeenMessageTime && !chatContainer.classList.contains('open')) {
                        unreadMessages++;
                    }
                }
                
                chatMessages.appendChild(messageDiv);
            });
            
            // Обновляем бейдж непрочитанных
            updateUnreadBadge();
            
            // Прокручиваем вниз
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Показываем popup для новых сообщений только если чат закрыт
            if (gameState.chatMessages.length > 0 && !chatContainer.classList.contains('open')) {
                const lastMessage = gameState.chatMessages[gameState.chatMessages.length - 1];
                if (!lastMessage.isSystem && lastMessage.timestamp > lastSeenMessageTime) {
                    showChatPopups();
                }
            }
            
            // Обновляем время последнего просмотренного сообщения
            lastSeenMessageTime = Date.now();
        }
        
        // Показать popup сообщения
        function showChatPopups() {
            // Очищаем контейнер
            chatPopupContainer.innerHTML = '';
            
            // Получаем последние 2 несистемных сообщения
            const recentMessages = gameState.chatMessages
                .filter(msg => !msg.isSystem)
                .slice(-2);
            
            // Отображаем их
            recentMessages.forEach(msg => {
                const popup = document.createElement('div');
                popup.className = 'chat-popup';
                
                if (msg.isAudio) {
                    popup.innerHTML = `
                        <div class="chat-popup-sender">${msg.senderName}</div>
                        <div class="chat-popup-content">
                            <i class="fas fa-microphone"></i> Голосовое сообщение
                        </div>
                    `;
                } else {
                    popup.innerHTML = `
                        <div class="chat-popup-sender">${msg.senderName}</div>
                        <div class="chat-popup-content">${msg.text}</div>
                    `;
                }
                
                chatPopupContainer.appendChild(popup);
                
                // Автоматическое скрытие через 5 секунд
                setTimeout(() => {
                    popup.style.opacity = '0';
                    popup.style.transform = 'translateY(20px)';
                    setTimeout(() => {
                        if (popup.parentNode) {
                            popup.parentNode.removeChild(popup);
                        }
                    }, 300);
                }, 5000);
            });
        }
        
        // Обновление бейджа непрочитанных сообщений
        function updateUnreadBadge() {
            if (unreadMessages > 0) {
                unreadBadge.textContent = unreadMessages;
                unreadBadge.style.display = 'flex';
            } else {
                unreadBadge.style.display = 'none';
            }
        }
        
        // Открыть/закрыть чат
        function toggleChat() {
            chatContainer.classList.toggle('open');
            
            if (chatContainer.classList.contains('open')) {
                // Сбрасываем счетчик непрочитанных при открытии
                unreadMessages = 0;
                updateUnreadBadge();
                lastSeenMessageTime = Date.now();
                
                // Очищаем popup сообщения
                chatPopupContainer.innerHTML = '';
                
                // Фокусируем поле ввода
                setTimeout(() => {
                    chatInput.focus();
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 300);
            }
        }
        
        // Закрыть чат
        function closeChat() {
            chatContainer.classList.remove('open');
        }
        
        // Копирование ID комнаты
        function copyRoomId() {
            navigator.clipboard.writeText(gameState.roomId);
            alert('ID комнаты скопирован! Отправьте его друзьям.');
        }
        
        // Создание комнаты
        function createRoom() {
            // Получаем имя игрока
            const name = getPlayerName();
            
            // Генерируем уникальный ID комнаты
            const roomId = 'MAF-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
            
            // Создаем игрока (хоста)
            const playerId = generatePlayerId();
            currentPlayer = {
                id: playerId,
                name: name,
                role: null,
                status: 'alive',
                isHost: true,
                isVIP: userState.isVIP,
                vipRole: userState.vipRole,
                lastSeen: Date.now()
            };
            
            // Инициализируем состояние игры
            gameState = {
                roomId: roomId,
                players: [currentPlayer],
                currentPlayer: null,
                dayCount: 1,
                phase: 'lobby',
                gameOver: false,
                winner: null,
                logs: [{message: `Комната создана. ${name} присоединился как создатель.`, timestamp: Date.now()}],
                votes: {},
                killTarget: null,
                checkTarget: null,
                healTarget: null,
                protectTarget: null,
                murderTarget: null,
                chatMessages: [{
                    isSystem: true,
                    text: `Игра создана. ${name} присоединился как создатель.`,
                    timestamp: Date.now()
                }],
                status: 'waiting',
                phaseEndTime: 0,
                phaseDuration: 120000
            };
            
            // Сохраняем состояние в Firebase
            saveGameState();
            
            // Обновляем интерфейс
            roomIdElement.textContent = roomId;
            
            // Переключаемся на лобби
            joinScreen.classList.remove('active');
            lobbyScreen.classList.add('active');
            
            // Обновляем лобби
            updateLobby();
            
            // Слушаем изменения в Firebase
            listenForGameChanges();
        }
        
        // Присоединение к комнате
        function joinRoom() {
            const roomId = roomIdInput.value.trim();
            
            if (!roomId) {
                alert('Введите ID комнаты');
                return;
            }
            
            // Получаем имя игрока
            const name = getPlayerName();
            
            // Создаем игрока
            const playerId = generatePlayerId();
            currentPlayer = {
                id: playerId,
                name: name,
                role: null,
                status: 'alive',
                isHost: false,
                isVIP: userState.isVIP,
                vipRole: userState.vipRole,
                lastSeen: Date.now()
            };
            
            // Загружаем состояние игры из Firebase
            loadGameState(roomId, () => {
                // Проверяем, не заполнена ли комната
                if (gameState.players.length >= 5) {
                    alert('Комната заполнена');
                    return;
                }
                
                // Проверяем, не занято ли имя
                if (gameState.players.some(p => p.name === name)) {
                    // Если имя занято, добавляем суффикс
                    let newName = name;
                    let counter = 1;
                    while (gameState.players.some(p => p.name === newName)) {
                        counter++;
                        newName = `${name}${counter}`;
                    }
                    currentPlayer.name = newName;
                }
                
                // Проверяем статус комнаты
                if (gameState.status !== 'waiting') {
                    alert('Игра уже началась, присоединиться нельзя');
                    return;
                }
                
                // Добавляем игрока
                gameState.players.push(currentPlayer);
                
                // Добавляем сообщение в чат
                gameState.chatMessages.push({
                    isSystem: true,
                    text: `${currentPlayer.name} присоединился к игре.`,
                    timestamp: Date.now()
                });
                
                saveGameState();
                
                // Обновляем интерфейс
                roomIdElement.textContent = gameState.roomId;
                
                // Переключаемся на лобби
                joinScreen.classList.remove('active');
                lobbyScreen.classList.add('active');
                
                // Обновляем лобби
                updateLobby();
                
                // Слушаем изменения в Firebase
                listenForGameChanges();
            });
        }
        
        // Генерация ID игрока
        function generatePlayerId() {
            return 'player_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
        }
        
        // Загрузка состояния игры из Firebase
        function loadGameState(roomId, callback) {
            const gameRef = database.ref(`rooms/${roomId}`);
            gameRef.once('value').then(snapshot => {
                if (snapshot.exists()) {
                    gameState = snapshot.val();
                    callback();
                } else {
                    alert('Комната не найдена');
                }
            });
        }
        
        // Сохранение состояния игры в Firebase
        function saveGameState() {
            const gameRef = database.ref(`rooms/${gameState.roomId}`);
            gameRef.set(gameState);
        }
        
        // Прослушивание изменений в игре
        function listenForGameChanges() {
            const gameRef = database.ref(`rooms/${gameState.roomId}`);
            gameRef.on('value', snapshot => {
                if (snapshot.exists()) {
                    gameState = snapshot.val();
                    
                    // Обновляем интерфейс в зависимости от экрана
                    if (lobbyScreen.classList.contains('active')) {
                        updateLobby();
                    } else if (gameScreen.classList.contains('active')) {
                        updateGameScreen();
                    } else if (resultScreen.classList.contains('active')) {
                        updateResultScreen();
                    }
                    
                    // Обновляем чат всегда
                    renderChatMessages();
                    
                    // Если игра началась, переключаем на игровой экран
                    if (gameState.phase !== 'lobby' && lobbyScreen.classList.contains('active')) {
                        lobbyScreen.classList.remove('active');
                        gameScreen.classList.add('active');
                        updateGameScreen();
                    }
                    
                    // Если игра завершена, переключаем на экран результатов
                    if (gameState.gameOver && gameScreen.classList.contains('active')) {
                        gameScreen.classList.remove('active');
                        resultScreen.classList.add('active');
                        updateResultScreen();
                    }
                    
                    // Обновляем таймер
                    updatePhaseTimer();
                }
            });
        }
        
        // Обновление лобби
        function updateLobby() {
            playerList.innerHTML = '';
            playerCount.textContent = gameState.players.length;
            
            // Обновляем статус лобби
            if (gameState.players.length === 0) {
                lobbyStatus.textContent = 'Ожидание игроков';
            } else if (gameState.players.length < 3) {
                lobbyStatus.textContent = `Ожидание игроков (минимум 3)`;
            } else if (gameState.players.length < 5) {
                lobbyStatus.textContent = `Ожидание игроков (${5 - gameState.players.length} из 5)`;
            } else {
                lobbyStatus.textContent = 'Лобби заполнено!';
            }
            
            // Активируем кнопку старта для хоста
            startBtn.disabled = !(currentPlayer.isHost && gameState.players.length >= 3);
            
            // Отображаем игроков
            gameState.players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = `player-card ${player.isHost ? 'host' : ''}`;
                
                let playerInfo = `<div class="player-name">${player.name}</div>`;
                if (player.isHost) {
                    playerInfo += `<div class="player-status"><i class="fas fa-crown"></i> Создатель</div>`;
                } else {
                    playerInfo += `<div class="player-status">Ожидание...</div>`;
                }
                
                if (player.isVIP) {
                    playerInfo += `<div class="player-status"><span class="vip-badge">VIP</span></div>`;
                }
                
                playerCard.innerHTML = playerInfo;
                playerList.appendChild(playerCard);
            });
        }
        
        // Начало игры
        function startGame() {
            // Перемешиваем роли
            shuffleRoles();
            
            // Назначаем роли
            assignRoles();
            
            // Добавляем сообщение в чат
            gameState.chatMessages.push({
                isSystem: true,
                text: 'Игра началась! Наступает ночь...',
                timestamp: Date.now()
            });
            
            // Устанавливаем первого игрока
            gameState.currentPlayer = gameState.players[0].id;
            gameState.phase = 'night';
            gameState.status = 'in-progress'; // Меняем статус комнаты
            gameState.logs = [{message: 'Игра началась! Наступает ночь...', timestamp: Date.now()}];
            
            // Устанавливаем таймер фазы
            gameState.phaseEndTime = Date.now() + gameState.phaseDuration;
            
            // Сохраняем состояние
            saveGameState();
        }
        
        // Перемешивание ролей
        function shuffleRoles() {
            for (let i = roles.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [roles[i], roles[j]] = [roles[j], roles[i]];
            }
        }
        
        // Назначение ролей игрокам
        function assignRoles() {
            let assignedRoles = [...roles];
            
            // Назначаем VIP-роли если есть
            gameState.players.forEach(player => {
                if (player.isVIP && player.vipRole) {
                    player.role = player.vipRole;
                }
            });
            
            // Назначаем оставшиеся роли
            gameState.players.forEach((player, index) => {
                if (!player.role) {
                    player.role = assignedRoles[index] || 'civilian';
                }
            });
        }
        
        // Обновление игрового экрана
        function updateGameScreen() {
            // Находим текущего игрока в состоянии
            const player = gameState.players.find(p => p.id === currentPlayer.id);
            if (!player) return;
            
            // Обновляем количество живых игроков
            const alivePlayers = gameState.players.filter(p => p.status === 'alive');
            gamePlayerCount.textContent = `${alivePlayers.length}/${gameState.players.length}`;
            
            dayCount.textContent = gameState.dayCount;
            
            // Установка фазы
            phaseDisplay.textContent = gameState.phase === 'night' ? 'НОЧЬ' : 'ДЕНЬ';
            phaseDisplay.className = `phase-display ${gameState.phase}`;
            
            // Отображение роли текущего игрока
            const roleName = roleTranslations[player.role] || player.role;
            playerRole.innerHTML = `${roleName}${player.isVIP ? ' <span class="vip-badge">VIP</span>' : ''}`;
            roleInfo.textContent = roleDescriptions[player.role] || '';
            playerStatus.textContent = `Статус: ${player.status === 'alive' ? 'жив' : 'мёртв'}`;
            playerStatus.className = `player-status ${player.status}`;
            
            // Обновление описания действий
            updateActionDescription(player);
            
            // Обновление логов
            updateGameLog();
            
            // Обновляем таймер
            updatePhaseTimer();
        }
        
        // Обновление таймера фазы
        function updatePhaseTimer() {
            if (timerInterval) clearInterval(timerInterval);
            
            if (gameState.phase === 'lobby' || gameState.gameOver) return;
            
            timerInterval = setInterval(() => {
                const now = Date.now();
                const timeLeft = Math.max(0, gameState.phaseEndTime - now);
                const minutes = Math.floor(timeLeft / 60000);
                const seconds = Math.floor((timeLeft % 60000) / 1000);
                
                phaseTimer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Автоматическое завершение фазы по таймеру
                if (timeLeft <= 0) {
                    endPhase();
                }
            }, 1000);
        }
        
        // Обновление описания действий
        function updateActionDescription(player) {
            actionButtons.innerHTML = '';
            
            // Если игрок мертв
            if (player.status !== 'alive') {
                actionDescription.textContent = 'Вы мертвы и не можете действовать.';
                return;
            }
            
            if (gameState.phase === 'night') {
                switch(player.role) {
                    case 'mafia':
                        actionDescription.textContent = 'Выберите игрока для устранения:';
                        renderPlayerActions('kill', player);
                        break;
                    case 'sheriff':
                        actionDescription.textContent = 'Выберите игрока для проверки:';
                        renderPlayerActions('check', player);
                        break;
                    case 'doctor':
                        actionDescription.textContent = 'Выберите игрока для лечения:';
                        renderPlayerActions('heal', player);
                        break;
                    case 'lover':
                        actionDescription.textContent = 'Выберите игрока для защиты:';
                        renderPlayerActions('protect', player);
                        break;
                    case 'maniac':
                        actionDescription.textContent = 'Выберите жертву:';
                        renderPlayerActions('murder', player);
                        break;
                    default:
                        actionDescription.textContent = 'Вы спите... Наступает ночь.';
                }
            } else {
                actionDescription.textContent = 'Обсудите и выберите игрока для исключения:';
                renderPlayerActions('vote', player);
            }
        }
        
        // Рендер действий с игроками
        function renderPlayerActions(actionType, currentPlayer) {
            const alivePlayers = gameState.players.filter(p => 
                p.status === 'alive' && p.id !== currentPlayer.id
            );
            
            if (alivePlayers.length === 0) {
                actionDescription.textContent = 'Нет других игроков для действия';
                return;
            }
            
            alivePlayers.forEach(player => {
                const btn = document.createElement('button');
                btn.textContent = player.name;
                btn.style.margin = '4px';
                btn.style.fontSize = '0.9rem';
                
                btn.addEventListener('click', () => {
                    if (actionType === 'kill') {
                        // Мафия выбирает жертву
                        gameState.killTarget = player.id;
                        addLog(`${currentPlayer.name} (мафия) выбрал(а) ${player.name} для устранения`, 'mafia');
                    } else if (actionType === 'check') {
                        // Шериф проверяет игрока
                        gameState.checkTarget = player.id;
                        const role = roleTranslations[player.role];
                        addLog(`${currentPlayer.name} (шериф) проверил(а) ${player.name}. Роль: ${role}`, 'sheriff');
                    } else if (actionType === 'heal') {
                        // Доктор лечит игрока
                        gameState.healTarget = player.id;
                        addLog(`${currentPlayer.name} (доктор) вылечил(а) ${player.name}`);
                    } else if (actionType === 'protect') {
                        // Любовница защищает игрока
                        gameState.protectTarget = player.id;
                        addLog(`${currentPlayer.name} (любовница) защитил(а) ${player.name}`);
                    } else if (actionType === 'murder') {
                        // Маньяк убивает игрока
                        gameState.murderTarget = player.id;
                        addLog(`${currentPlayer.name} (маньяк) выбрал(а) ${player.name} для убийства`);
                    } else {
                        // Голосование днем
                        gameState.votes[currentPlayer.id] = player.id;
                        addLog(`${currentPlayer.name} проголосовал(а) против ${player.name}`);
                    }
                    
                    // Переходим к следующему игроку
                    nextPlayer();
                });
                
                actionButtons.appendChild(btn);
            });
            
            // Кнопка пропуска
            const skipBtn = document.createElement('button');
            skipBtn.textContent = 'Пропустить';
            skipBtn.style.margin = '4px';
            skipBtn.style.background = '#555';
            skipBtn.style.fontSize = '0.9rem';
            
            skipBtn.addEventListener('click', () => {
                addLog(`${currentPlayer.name} пропустил(а) действие`);
                nextPlayer();
            });
            
            actionButtons.appendChild(skipBtn);
        }
        
        // Добавление записи в лог
        function addLog(message, type = '') {
            gameState.logs.push({message, type, timestamp: Date.now()});
            
            if (gameState.logs.length > 10) {
                gameState.logs.shift();
            }
            
            saveGameState();
        }
        
        // Обновление логов
        function updateGameLog() {
            gameLog.innerHTML = '';
            
            gameState.logs.forEach(log => {
                const logEntry = document.createElement('div');
                logEntry.className = `log-entry ${log.type ? log.type + '-log' : ''}`;
                logEntry.innerHTML = `<i class="far fa-clock"></i> ${log.message}`;
                gameLog.appendChild(logEntry);
            });
            
            // Прокрутка вниз
            gameLog.scrollTop = gameLog.scrollHeight;
        }
        
        // Следующий игрок
        function nextPlayer() {
            const currentIndex = gameState.players.findIndex(p => p.id === gameState.currentPlayer);
            let nextIndex = (currentIndex + 1) % gameState.players.length;
            
            // Пропускаем мёртвых игроков
            while (nextIndex !== currentIndex && gameState.players[nextIndex].status !== 'alive') {
                nextIndex = (nextIndex + 1) % gameState.players.length;
            }
            
            // Если все игроки мертвы, завершаем фазу
            if (gameState.players[nextIndex].status !== 'alive') {
                endPhase();
                return;
            }
            
            gameState.currentPlayer = gameState.players[nextIndex].id;
            
            // Если круг завершён, меняем фазу
            if (gameState.currentPlayer === gameState.players[0].id) {
                endPhase();
            }
            
            // Сохраняем состояние
            saveGameState();
            checkGameOver();
        }
        
        // Завершение фазы
        function endPhase() {
            if (gameState.phase === 'night') {
                // Обработка действий ночи
                processNightActions();
                
                gameState.phase = 'day';
                addLog('Наступает день. Обсуждение начинается...');
                gameState.dayCount++;
            } else {
                // Обработка голосования днем
                const voteCounts = {};
                Object.values(gameState.votes).forEach(vote => {
                    voteCounts[vote] = (voteCounts[vote] || 0) + 1;
                });
                
                let maxVotes = 0;
                let votedPlayerId = null;
                
                for (const [playerId, votes] of Object.entries(voteCounts)) {
                    if (votes > maxVotes) {
                        maxVotes = votes;
                        votedPlayerId = playerId;
                    }
                }
                
                if (votedPlayerId && maxVotes > 0) {
                    const votedPlayer = gameState.players.find(p => p.id === votedPlayerId);
                    if (votedPlayer) {
                        votedPlayer.status = 'dead';
                        addLog(`Игроки решили исключить ${votedPlayer.name}. Роль: ${roleTranslations[votedPlayer.role]}`);
                    }
                } else {
                    addLog('Игроки не смогли договориться, никто не исключен.');
                }
                
                gameState.votes = {};
                gameState.phase = 'night';
                addLog('Наступает ночь. Город засыпает...');
            }
            
            // Устанавливаем таймер для новой фазы
            gameState.phaseEndTime = Date.now() + gameState.phaseDuration;
            
            // Сбрасываем текущего игрока на первого живого
            const firstAlivePlayer = gameState.players.find(p => p.status === 'alive');
            if (firstAlivePlayer) {
                gameState.currentPlayer = firstAlivePlayer.id;
            }
            
            // Сохраняем состояние
            saveGameState();
            checkGameOver();
        }
        
        // Обработка ночных действий
        function processNightActions() {
            // Доктор: лечит выбранного игрока
            if (gameState.healTarget) {
                const targetPlayer = gameState.players.find(p => p.id === gameState.healTarget);
                if (targetPlayer) {
                    // Если мафия выбрала того же игрока, отменяем убийство
                    if (gameState.killTarget === gameState.healTarget) {
                        gameState.killTarget = null;
                        addLog(`Доктор спас ${targetPlayer.name}!`);
                    }
                }
                gameState.healTarget = null;
            }
            
            // Любовница: защищает выбранного игрока
            if (gameState.protectTarget) {
                const targetPlayer = gameState.players.find(p => p.id === gameState.protectTarget);
                if (targetPlayer) {
                    // Если мафия выбрала защищенного, отменяем убийство
                    if (gameState.killTarget === gameState.protectTarget) {
                        gameState.killTarget = null;
                        addLog(`Любовница защитила ${targetPlayer.name}!`);
                    }
                }
                gameState.protectTarget = null;
            }
            
            // Маньяк: убивает выбранного игрока
            if (gameState.murderTarget) {
                const targetPlayer = gameState.players.find(p => p.id === gameState.murderTarget);
                if (targetPlayer && targetPlayer.status === 'alive') {
                    targetPlayer.status = 'dead';
                    addLog(`Маньяк убил ${targetPlayer.name}!`);
                }
                gameState.murderTarget = null;
            }
            
            // Мафия: убивает выбранного игрока
            if (gameState.killTarget) {
                const targetPlayer = gameState.players.find(p => p.id === gameState.killTarget);
                if (targetPlayer && targetPlayer.status === 'alive') {
                    targetPlayer.status = 'dead';
                    addLog(`Мафия убила ${targetPlayer.name}!`);
                }
                gameState.killTarget = null;
            }
        }
        
        // Проверка окончания игры
        function checkGameOver() {
            const alivePlayers = gameState.players.filter(p => p.status === 'alive');
            const mafiaCount = alivePlayers.filter(p => p.role === 'mafia').length;
            const civiliansCount = alivePlayers.filter(p => 
                p.role !== 'mafia' && 
                p.role !== 'maniac' && 
                p.role !== 'doctor' && 
                p.role !== 'lover'
            ).length;
            
            const maniacAlive = alivePlayers.some(p => p.role === 'maniac');
            const doctorAlive = alivePlayers.some(p => p.role === 'doctor');
            const loverAlive = alivePlayers.some(p => p.role === 'lover');
            
            // Победа мафии
            if (mafiaCount >= (alivePlayers.length - mafiaCount)) {
                endGame('mafia');
                return;
            }
            
            // Победа мирных
            if (mafiaCount === 0 && !maniacAlive) {
                endGame('civilians');
                return;
            }
            
            // Победа маньяка
            if (maniacAlive && alivePlayers.length === 1) {
                endGame('maniac');
                return;
            }
        }
        
        // Завершение игры
        function endGame(winner) {
            gameState.gameOver = true;
            gameState.winner = winner;
            gameState.status = 'completed'; // Меняем статус комнаты
            
            // Добавляем сообщение в чат
            let winnerText = '';
            switch(winner) {
                case 'mafia':
                    winnerText = 'Победа мафии!';
                    break;
                case 'civilians':
                    winnerText = 'Победа мирных жителей!';
                    break;
                case 'maniac':
                    winnerText = 'Победа маньяка!';
                    break;
                default:
                    winnerText = 'Игра завершена!';
            }
                
            gameState.chatMessages.push({
                isSystem: true,
                text: `Игра завершена! ${winnerText}`,
                timestamp: Date.now()
            });
            
            // Обновляем статистику пользователя
            if (currentUser) {
                const player = gameState.players.find(p => p.id === currentPlayer.id);
                if (player) {
                    const won = (winner === 'mafia' && player.role === 'mafia') || 
                               (winner === 'civilians' && player.role !== 'mafia' && player.role !== 'maniac') ||
                               (winner === 'maniac' && player.role === 'maniac');
                    updateStatsAfterGame(player.role, won);
                }
            }
            
            // Очищаем таймер
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            saveGameState();
        }
        
        // Обновление экрана результатов
        function updateResultScreen() {
            // Установка заголовка
            switch(gameState.winner) {
                case 'mafia':
                    winnerTitle.textContent = 'Победа мафии!';
                    break;
                case 'civilians':
                    winnerTitle.textContent = 'Победа мирных жителей!';
                    break;
                case 'maniac':
                    winnerTitle.textContent = 'Победа маньяка!';
                    break;
                default:
                    winnerTitle.textContent = 'Игра завершена!';
            }
            
            // Отображение результатов игроков
            resultPlayerList.innerHTML = '';
            
            gameState.players.forEach(player => {
                const playerCard = document.createElement('div');
                playerCard.className = `player-card ${player.role} ${player.status}`;
                
                const roleClass = player.role + '-badge';
                const roleName = roleTranslations[player.role];
                
                playerCard.innerHTML = `
                    <div class="player-name">${player.name}</div>
                    <div>
                        <span class="role-badge ${roleClass}">${roleName}</span>
                    </div>
                    <div class="player-status ${player.status}">
                        ${player.status === 'alive' ? 'Выжил' : 'Убит'}
                    </div>
                `;
                
                resultPlayerList.appendChild(playerCard);
            });
        }
        
        // Перезапуск игры
        function restartGame() {
            // Переключение на экран входа
            resultScreen.classList.remove('active');
            joinScreen.classList.add('active');
            
            // Очищаем таймер
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            // Сброс состояния
            gameState = {
                roomId: '',
                players: [],
                currentPlayer: null,
                dayCount: 1,
                phase: 'night',
                gameOver: false,
                winner: null,
                logs: [],
                votes: {},
                killTarget: null,
                checkTarget: null,
                healTarget: null,
                protectTarget: null,
                murderTarget: null,
                chatMessages: [],
                status: 'waiting',
                phaseEndTime: 0,
                phaseDuration: 120000
            };
            
            currentPlayer = {
                id: null,
                name: '',
                role: null,
                status: 'alive',
                isHost: false,
                isVIP: false,
                lastSeen: Date.now()
            };
        }
        
        // Возврат на экран ввода ID
        function goBackToJoinScreen() {
            // Удаляем игрока из комнаты
            if (gameState.roomId) {
                gameState.players = gameState.players.filter(p => p.id !== currentPlayer.id);
                
                // Если игроков не осталось, удаляем комнату
                if (gameState.players.length === 0) {
                    const roomRef = database.ref(`rooms/${gameState.roomId}`);
                    roomRef.remove();
                } else {
                    // Добавляем сообщение о выходе
                    gameState.chatMessages.push({
                        isSystem: true,
                        text: `${currentPlayer.name} покинул игру.`,
                        timestamp: Date.now()
                    });
                    
                    saveGameState();
                }
            }
            
            // Очищаем таймер
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
            
            lobbyScreen.classList.remove('active');
            joinScreen.classList.add('active');
        }
        
        // Возврат в лобби
        function goBackToLobby() {
            gameScreen.classList.remove('active');
            lobbyScreen.classList.add('active');
        }
        
        // Запуск игры при загрузке
        window.onload = initGame;
    </script>
</body>
</html>
